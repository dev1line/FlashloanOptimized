#!/bin/bash
# Git pre-push hook to check code format before pushing
# This is a safety net in case pre-commit hook was bypassed

set +e

echo "üîç Running pre-push format check..."

# Check if forge is available
if ! command -v forge &> /dev/null; then
    echo "‚ö†Ô∏è  Warning: forge not found. Skipping format check."
    exit 0
fi

# Get list of Solidity files that will be pushed (exclude lib/ and submodules)
BRANCH=$(git rev-parse --abbrev-ref HEAD)
REMOTE_BRANCH="origin/$BRANCH"

# Check if remote branch exists
if ! git rev-parse --verify "$REMOTE_BRANCH" >/dev/null 2>&1; then
    # If remote branch doesn't exist, check all Solidity files in src/ and test/
    SOL_FILES=$(git diff --name-only --diff-filter=ACM HEAD 2>/dev/null | grep -E '^(src|test)/.*\.sol$' || true)
else
    # Get files that differ from remote (exclude lib/ and submodules)
    SOL_FILES=$(git diff --name-only --diff-filter=ACM "$REMOTE_BRANCH"..HEAD 2>/dev/null | grep -E '^(src|test)/.*\.sol$' || true)
fi

# If no Solidity files changed, skip check
if [ -z "$SOL_FILES" ]; then
    echo "‚úÖ No Solidity files to check (excluding lib/)."
    exit 0
fi

# Format files first (auto-fix)
echo "üìù Auto-formatting Solidity files..."
if command -v timeout &> /dev/null; then
    timeout 30 forge fmt > /dev/null 2>&1
    FORMAT_EXIT=$?
    if [ $FORMAT_EXIT -eq 124 ]; then
        echo "‚ö†Ô∏è  Formatting timed out. Skipping check..."
        exit 0
    fi
else
    forge fmt > /dev/null 2>&1
fi

# Check if there are uncommitted changes after formatting
UNCOMMITTED=$(git diff --name-only | grep -E '^(src|test)/.*\.sol$' || true)

if [ -n "$UNCOMMITTED" ]; then
    echo ""
    echo "‚ö†Ô∏è  Code was auto-formatted. Please commit the changes:"
    echo "   git add ."
    echo "   git commit -m 'chore: format code'"
    echo "   git push"
    echo ""
    echo "üìã Formatted files:"
    echo "$UNCOMMITTED" | sed 's/^/   /'
    echo ""
    # Don't block push - just warn
    exit 0
fi

echo "‚úÖ Code format check passed!"
exit 0

