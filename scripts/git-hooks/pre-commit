#!/bin/bash
# Git pre-commit hook to automatically format Solidity code
# This ensures code is always formatted before commit

# Don't exit on error immediately - we want to handle errors gracefully
set +e

# Get list of staged Solidity files
STAGED_SOL_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.sol$' || true)

# If no Solidity files are staged, skip formatting
if [ -z "$STAGED_SOL_FILES" ]; then
    exit 0
fi

echo "ðŸ” Running pre-commit checks for Solidity files..."

# Check if forge is available
if ! command -v forge &> /dev/null; then
    echo "âš ï¸  Warning: forge not found. Skipping format check."
    exit 0
fi

# Format all Solidity files with timeout (max 30 seconds)
echo "ðŸ“ Formatting Solidity files..."
if command -v timeout &> /dev/null; then
    timeout 30 forge fmt > /dev/null 2>&1
    FORMAT_EXIT=$?
    if [ $FORMAT_EXIT -eq 124 ]; then
        echo "âš ï¸  Formatting timed out. Skipping format check..."
        exit 0
    fi
else
    # If timeout command is not available, run without timeout
    forge fmt > /dev/null 2>&1
fi

# Check if formatting created any changes (only check Solidity files)
UNSTAGED_CHANGES=$(git diff --name-only 2>/dev/null | grep '\.sol$' || true)

# If there are unstaged changes after formatting, add them to staging automatically
if [ -n "$UNSTAGED_CHANGES" ]; then
    echo "ðŸ“ Auto-formatting detected changes. Adding formatted files to staging..."
    for file in $UNSTAGED_CHANGES; do
        if [ -f "$file" ]; then
            git add "$file" 2>/dev/null || true
        fi
    done
    echo "âœ… Formatted files have been added to staging."
fi

echo "âœ… Pre-commit checks completed!"
exit 0

